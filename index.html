<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Gesti√≥n de Proyectos</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        * { box-sizing: border-box; }
        body { margin: 0; font-family: system-ui, -apple-system, sans-serif; }
    </style>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect } = React;

        const App = () => {
            const [boards, setBoards] = useState([]);
            const [currentView, setCurrentView] = useState('dashboard');
            const [selectedBoard, setSelectedBoard] = useState(null);
            const [showNewBoardModal, setShowNewBoardModal] = useState(false);
            const [showTaskModal, setShowTaskModal] = useState(false);
            const [selectedTask, setSelectedTask] = useState(null);

            useEffect(() => {
                try {
                    const data = localStorage.getItem('boards');
                    if (data) setBoards(JSON.parse(data));
                } catch (e) {
                    console.error('Error cargando datos:', e);
                }
            }, []);

            const saveData = (data) => {
                try {
                    localStorage.setItem('boards', JSON.stringify(data));
                    setBoards([...data]);
                } catch (e) {
                    console.error('Error guardando:', e);
                    alert('Error al guardar los datos');
                }
            };

            const createBoard = (name) => {
                if (!name) return;
                const newBoard = {
                    id: Date.now(),
                    name,
                    lists: [
                        { id: 1, name: 'Pendiente', tasks: [] },
                        { id: 2, name: 'En Proceso', tasks: [] },
                        { id: 3, name: 'Finalizado', tasks: [] }
                    ]
                };
                saveData([...boards, newBoard]);
                setShowNewBoardModal(false);
            };

            const createTask = (boardId, listId, title) => {
                if (!title) return;
                const updated = boards.map(b => {
                    if (b.id === boardId) {
                        return {
                            ...b,
                            lists: b.lists.map(l => {
                                if (l.id === listId) {
                                    return {
                                        ...l,
                                        tasks: [...l.tasks, { 
                                            id: Date.now(), 
                                            title, 
                                            subtasks: [],
                                            desc: '',
                                            date: ''
                                        }]
                                    };
                                }
                                return l;
                            })
                        };
                    }
                    return b;
                });
                saveData(updated);
                if (selectedBoard && selectedBoard.id === boardId) {
                    setSelectedBoard(updated.find(b => b.id === boardId));
                }
            };

            const updateTask = (boardId, listId, taskId, updates) => {
                const updated = boards.map(b => {
                    if (b.id === boardId) {
                        return {
                            ...b,
                            lists: b.lists.map(l => {
                                if (l.id === listId) {
                                    return {
                                        ...l,
                                        tasks: l.tasks.map(t => t.id === taskId ? { ...t, ...updates } : t)
                                    };
                                }
                                return l;
                            })
                        };
                    }
                    return b;
                });
                saveData(updated);
                if (selectedBoard && selectedBoard.id === boardId) {
                    setSelectedBoard(updated.find(b => b.id === boardId));
                }
            };

            const moveTask = (taskId, fromList, toList, boardId) => {
                const updated = boards.map(b => {
                    if (b.id === boardId) {
                        let task = null;
                        const lists = b.lists.map(l => {
                            if (l.id === fromList) {
                                task = l.tasks.find(t => t.id === taskId);
                                return { ...l, tasks: l.tasks.filter(t => t.id !== taskId) };
                            }
                            return l;
                        }).map(l => {
                            if (l.id === toList && task) {
                                return { ...l, tasks: [...l.tasks, task] };
                            }
                            return l;
                        });
                        return { ...b, lists };
                    }
                    return b;
                });
                saveData(updated);
                if (selectedBoard && selectedBoard.id === boardId) {
                    setSelectedBoard(updated.find(b => b.id === boardId));
                }
            };

            const deleteBoard = (boardId) => {
                if (!confirm('¬øEliminar este tablero?')) return;
                saveData(boards.filter(b => b.id !== boardId));
                if (selectedBoard?.id === boardId) {
                    setSelectedBoard(null);
                    setCurrentView('dashboard');
                }
            };

            const getStats = (board) => {
                const p = board.lists[0].tasks.length;
                const i = board.lists[1].tasks.length;
                const c = board.lists[2].tasks.length;
                const total = p + i + c;
                return { p, i, c, total, pct: total ? Math.round((c / total) * 100) : 0 };
            };

            const getSubtaskPct = (task) => {
                if (!task.subtasks || !task.subtasks.length) return 100;
                const done = task.subtasks.filter(s => s.done).length;
                return Math.round((done / task.subtasks.length) * 100);
            };

            const exportExcel = (start, end) => {
                try {
                    const tasks = boards.flatMap(b => b.lists.flatMap(l => l.tasks.map(t => ({
                        Tablero: b.name,
                        Estado: l.name,
                        Tarea: t.title,
                        Descripcion: t.desc || '',
                        Fecha: t.date || '',
                        Progreso: getSubtaskPct(t) + '%',
                        Subtareas: t.subtasks ? `${t.subtasks.filter(s=>s.done).length}/${t.subtasks.length}` : '0/0'
                    })))).filter(t => {
                        if (!t.Fecha) return true;
                        return t.Fecha >= start && t.Fecha <= end;
                    });
                    const ws = XLSX.utils.json_to_sheet(tasks);
                    const wb = XLSX.utils.book_new();
                    XLSX.utils.book_append_sheet(wb, ws, "Tareas");
                    XLSX.writeFile(wb, `informe_${start}_${end}.xlsx`);
                } catch (e) {
                    alert('Error al exportar Excel: ' + e.message);
                }
            };

            const exportPDF = (start, end) => {
                try {
                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF();
                    const tasks = boards.flatMap(b => b.lists.flatMap(l => l.tasks.filter(t => {
                        if (!t.date) return true;
                        return t.date >= start && t.date <= end;
                    }).map(t => ({
                        board: b.name,
                        list: l.name,
                        title: t.title,
                        date: t.date || 'Sin fecha',
                        pct: getSubtaskPct(t)
                    }))));
                    
                    doc.setFontSize(16);
                    doc.text('INFORME DE TAREAS', 20, 20);
                    doc.setFontSize(10);
                    doc.text(`Per√≠odo: ${start} - ${end}`, 20, 30);
                    doc.text(`Total de tareas: ${tasks.length}`, 20, 38);
                    
                    let y = 50;
                    tasks.forEach((t, i) => {
                        if (y > 270) { 
                            doc.addPage(); 
                            y = 20; 
                        }
                        doc.setFontSize(10);
                        doc.text(`${i+1}. ${t.title}`, 20, y);
                        doc.setFontSize(8);
                        doc.text(`   Tablero: ${t.board} | Estado: ${t.list}`, 20, y + 5);
                        doc.text(`   Fecha: ${t.date} | Progreso: ${t.pct}%`, 20, y + 10);
                        y += 20;
                    });
                    doc.save(`informe_${start}_${end}.pdf`);
                } catch (e) {
                    alert('Error al exportar PDF: ' + e.message);
                }
            };

            const genReport = () => {
                const start = prompt('Fecha inicio (YYYY-MM-DD):');
                const end = prompt('Fecha fin (YYYY-MM-DD):');
                if (!start || !end) return;
                const fmt = prompt('Formato:\n1 = Excel\n2 = PDF\n\nEscribe 1 o 2:');
                if (fmt === '1') exportExcel(start, end);
                else if (fmt === '2') exportPDF(start, end);
                else alert('Opci√≥n no v√°lida');
            };

            return (
                <div style={{ minHeight: '100vh', backgroundColor: '#f9fafb' }}>
                    <nav style={{ backgroundColor: 'white', boxShadow: '0 1px 3px rgba(0,0,0,0.1)', padding: '1rem', display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                        <h1 style={{ fontSize: '1.5rem', fontWeight: 'bold', color: '#BAFF39', margin: 0 }}>Gesti√≥n de Proyectos</h1>
                        <div style={{ display: 'flex', gap: '0.75rem' }}>
                            <button onClick={() => setCurrentView('dashboard')} style={{ padding: '0.5rem 1rem', borderRadius: '0.375rem', backgroundColor: '#374151', color: 'white', border: 'none', cursor: 'pointer' }}>Dashboard</button>
                            <button onClick={genReport} style={{ padding: '0.5rem 1rem', borderRadius: '0.375rem', backgroundColor: '#4B5563', color: 'white', border: 'none', cursor: 'pointer' }}>Generar Informe</button>
                        </div>
                    </nav>

                    {currentView === 'dashboard' && (
                        <div style={{ padding: '1.5rem' }}>
                            <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: '1.5rem', alignItems: 'center' }}>
                                <h2 style={{ fontSize: '1.875rem', fontWeight: 'bold', margin: 0 }}>Dashboard</h2>
                                <button onClick={() => setShowNewBoardModal(true)} style={{ padding: '0.5rem 1rem', borderRadius: '0.375rem', backgroundColor: '#BAFF39', fontWeight: '600', border: 'none', cursor: 'pointer' }}>+ Nuevo Tablero</button>
                            </div>
                            <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fill, minmax(300px, 1fr))', gap: '1rem' }}>
                                {boards.map(b => {
                                    const stats = getStats(b);
                                    return (
                                        <div key={b.id} onClick={() => { setSelectedBoard(b); setCurrentView('board'); }} style={{ backgroundColor: 'white', padding: '1.25rem', borderRadius: '0.5rem', boxShadow: '0 1px 3px rgba(0,0,0,0.1)', cursor: 'pointer', border: '2px solid #BAFF39' }}>
                                            <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: '0.75rem' }}>
                                                <h3 style={{ fontSize: '1.25rem', fontWeight: 'bold', margin: 0 }}>{b.name}</h3>
                                                <button onClick={(e) => { e.stopPropagation(); deleteBoard(b.id); }} style={{ padding: '0.25rem 0.5rem', backgroundColor: '#EF4444', color: 'white', border: 'none', borderRadius: '0.25rem', cursor: 'pointer', fontSize: '0.75rem' }}>Eliminar</button>
                                            </div>
                                            <div style={{ display: 'grid', gridTemplateColumns: 'repeat(3, 1fr)', gap: '0.5rem', marginBottom: '0.75rem', textAlign: 'center', fontSize: '0.875rem' }}>
                                                <div style={{ backgroundColor: '#FEE2E2', padding: '0.5rem', borderRadius: '0.375rem' }}>
                                                    <div style={{ fontSize: '0.75rem' }}>Pendiente</div>
                                                    <div style={{ fontWeight: 'bold', color: '#DC2626' }}>{stats.p}</div>
                                                </div>
                                                <div style={{ backgroundColor: '#FEF3C7', padding: '0.5rem', borderRadius: '0.375rem' }}>
                                                    <div style={{ fontSize: '0.75rem' }}>En Proceso</div>
                                                    <div style={{ fontWeight: 'bold', color: '#D97706' }}>{stats.i}</div>
                                                </div>
                                                <div style={{ backgroundColor: '#D1FAE5', padding: '0.5rem', borderRadius: '0.375rem' }}>
                                                    <div style={{ fontSize: '0.75rem' }}>Finalizado</div>
                                                    <div style={{ fontWeight: 'bold', color: '#059669' }}>{stats.c}</div>
                                                </div>
                                            </div>
                                            <div style={{ display: 'flex', justifyContent: 'space-between', fontSize: '0.875rem', marginBottom: '0.25rem' }}>
                                                <span>Total: {stats.total}</span>
                                                <span style={{ fontWeight: 'bold', color: '#BAFF39' }}>{stats.pct}%</span>
                                            </div>
                                            <div style={{ width: '100%', backgroundColor: '#E5E7EB', borderRadius: '0.375rem', height: '0.5rem' }}>
                                                <div style={{ width: `${stats.pct}%`, backgroundColor: '#BAFF39', height: '100%', borderRadius: '0.375rem' }}></div>
                                            </div>
                                        </div>
                                    );
                                })}
                            </div>
                            {boards.length === 0 && (
                                <div style={{ textAlign: 'center', padding: '3rem', color: '#6B7280' }}>
                                    <p style={{ fontSize: '1.125rem' }}>No hay tableros creados</p>
                                    <p style={{ fontSize: '0.875rem' }}>Haz clic en "Nuevo Tablero" para comenzar</p>
                                </div>
                            )}
                        </div>
                    )}

                    {currentView === 'board' && selectedBoard && (
                        <div style={{ padding: '1.5rem' }}>
                            <button onClick={() => setCurrentView('dashboard')} style={{ color: '#2563EB', marginBottom: '1rem', background: 'none', border: 'none', cursor: 'pointer', fontSize: '1rem' }}>‚Üê Volver al Dashboard</button>
                            <h2 style={{ fontSize: '1.875rem', fontWeight: 'bold', marginBottom: '1.5rem' }}>{selectedBoard.name}</h2>
                            <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(300px, 1fr))', gap: '1rem' }}>
                                {selectedBoard.lists.map(list => (
                                    <div key={list.id} style={{ backgroundColor: '#F3F4F6', padding: '1rem', borderRadius: '0.5rem' }} onDragOver={e => e.preventDefault()} onDrop={e => {
                                        e.preventDefault();
                                        const data = e.dataTransfer.getData('task');
                                        if (data) {
                                            try {
                                                const {taskId, fromList} = JSON.parse(data);
                                                moveTask(taskId, fromList, list.id, selectedBoard.id);
                                            } catch (err) {
                                                console.error('Error moviendo tarea:', err);
                                            }
                                        }
                                    }}>
                                        <h3 style={{ fontWeight: 'bold', fontSize: '1.125rem', marginBottom: '1rem' }}>{list.name}</h3>
                                        <div style={{ display: 'flex', flexDirection: 'column', gap: '0.75rem' }}>
                                            {list.tasks.map(task => (
                                                <div key={task.id} draggable onDragStart={e => {
                                                    e.dataTransfer.setData('task', JSON.stringify({taskId: task.id, fromList: list.id}));
                                                }} onClick={() => { 
                                                    setSelectedTask({...task, listId: list.id}); 
                                                    setShowTaskModal(true); 
                                                }} style={{ padding: '0.75rem', borderRadius: '0.375rem', cursor: 'move', boxShadow: '0 1px 2px rgba(0,0,0,0.1)', backgroundColor: list.id===1?'#FCA5A5':list.id===2?'#FCD34D':'#6EE7B7' }}>
                                                    <div style={{ fontWeight: '600' }}>{task.title}</div>
                                                    {task.date && <div style={{ fontSize: '0.75rem', marginTop: '0.25rem' }}>üìÖ {task.date}</div>}
                                                    {task.subtasks && task.subtasks.length > 0 && (
                                                        <div style={{ marginTop: '0.5rem' }}>
                                                            <div style={{ fontSize: '0.75rem' }}>Subtareas: {task.subtasks.filter(s=>s.done).length}/{task.subtasks.length}</div>
                                                            <div style={{ width: '100%', backgroundColor: 'rgba(0,0,0,0.2)', borderRadius: '0.25rem', height: '0.25rem', marginTop: '0.25rem' }}>
                                                                <div style={{ width: `${getSubtaskPct(task)}%`, backgroundColor: '#2563EB', height: '100%', borderRadius: '0.25rem' }}></div>
                                                            </div>
                                                        </div>
                                                    )}
                                                </div>
                                            ))}
                                        </div>
                                        <button onClick={() => {
                                            const title = prompt('T√≠tulo de la tarea:');
                                            if (title) createTask(selectedBoard.id, list.id, title);
                                        }} style={{ width: '100%', marginTop: '0.75rem', padding: '0.5rem', border: '2px dashed #9CA3AF', borderRadius: '0.375rem', backgroundColor: 'transparent', cursor: 'pointer', color: '#6B7280' }}>+ Agregar Tarea</button>
                                    </div>
                                ))}
                            </div>
                        </div>
                    )}

                    {showNewBoardModal && (
                        <div style={{ position: 'fixed', inset: 0, backgroundColor: 'rgba(0,0,0,0.5)', display: 'flex', alignItems: 'center', justifyContent: 'center', zIndex: 50 }}>
                            <div style={{ backgroundColor: 'white', padding: '1.5rem', borderRadius: '0.5rem', width: '24rem' }}>
                                <h2 style={{ fontSize: '1.5rem', fontWeight: 'bold', marginBottom: '1rem' }}>Nuevo Tablero</h2>
                                <input id="boardName" placeholder="Nombre del tablero" style={{ width: '100%', padding: '0.5rem', border: '1px solid #D1D5DB', borderRadius: '0.375rem', marginBottom: '1rem' }}/>
                                <div style={{ display: 'flex', gap: '0.5rem' }}>
                                    <button onClick={() => { 
                                        const name = document.getElementById('boardName').value; 
                                        if(name) createBoard(name); 
                                    }} style={{ flex: 1, padding: '0.5rem', borderRadius: '0.375rem', backgroundColor: '#BAFF39', border: 'none', cursor: 'pointer', fontWeight: '600' }}>Crear</button>
                                    <button onClick={() => setShowNewBoardModal(false)} style={{ flex: 1, padding: '0.5rem', backgroundColor: '#D1D5DB', borderRadius: '0.375rem', border: 'none', cursor: 'pointer' }}>Cancelar</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {showTaskModal && selectedTask && (
                        <div style={{ position: 'fixed', inset: 0, backgroundColor: 'rgba(0,0,0,0.5)', display: 'flex', alignItems: 'center', justifyContent: 'center', zIndex: 50, overflow: 'auto' }}>
                            <div style={{ backgroundColor: 'white', padding: '1.5rem', borderRadius: '0.5rem', width: '90%', maxWidth: '42rem', maxHeight: '90vh', overflow: 'auto', margin: '2rem' }}>
                                <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: '1rem' }}>
                                    <h2 style={{ fontSize: '1.5rem', fontWeight: 'bold', margin: 0 }}>{selectedTask.title}</h2>
                                    <button onClick={() => setShowTaskModal(false)} style={{ fontSize: '1.5rem', background: 'none', border: 'none', cursor: 'pointer', padding: '0 0.5rem' }}>√ó</button>
                                </div>
                                <div style={{ display: 'flex', flexDirection: 'column', gap: '1rem' }}>
                                    <div>
                                        <label style={{ fontWeight: '600', display: 'block', marginBottom: '0.25rem' }}>Descripci√≥n:</label>
                                        <textarea value={selectedTask.desc || ''} onChange={e => setSelectedTask({...selectedTask, desc: e.target.value})} style={{ width: '100%', padding: '0.5rem', border: '1px solid #D1D5DB', borderRadius: '0.375rem' }} rows="3"/>
                                    </div>
                                    <div>
                                        <label style={{ fontWeight: '600', display: 'block', marginBottom: '0.25rem' }}>Fecha de vencimiento:</label>
                                        <input type="date" value={selectedTask.date || ''} onChange={e => setSelectedTask({...selectedTask, date: e.target.value})} style={{ width: '100%', padding: '0.5rem', border: '1px solid #D1D5DB', borderRadius: '0.375rem' }}/>
                                    </div>
                                    <div>
                                        <label style={{ fontWeight: '600', display: 'block', marginBottom: '0.5rem' }}>Subtareas:</label>
                                        {(selectedTask.subtasks || []).map((st, i) => (
                                            <div key={i} style={{ display: 'flex', gap: '0.5rem', marginBottom: '0.5rem', alignItems: 'center' }}>
                                                <input type="checkbox" checked={st.done || false} onChange={e => {
                                                    const subs = [...(selectedTask.subtasks || [])];
                                                    subs[i].done = e.target.checked;
                                                    setSelectedTask({...selectedTask, subtasks: subs});
                                                }} style={{ width: '1rem', height: '1rem' }}/>
                                                <input value={st.text || ''} onChange={e => {
                                                    const subs = [...(selectedTask.subtasks || [])];
                                                    subs[i].text = e.target.value;
                                                    setSelectedTask({...selectedTask, subtasks: subs});
                                                }} style={{ flex: 1, padding: '0.25rem 0.5rem', border: '1px solid #D1D5DB', borderRadius: '0.375rem' }} placeholder="Descripci√≥n de la subtarea"/>
                                                <button onClick={() => setSelectedTask({...selectedTask, subtasks: selectedTask.subtasks.filter((_,idx) => idx !== i)})} style={{ color: '#EF4444', background: 'none', border: 'none', cursor: 'pointer', fontSize: '1.25rem', padding: '0 0.5rem' }}>√ó</button>
                                            </div>
                                        ))}
                                        <button onClick={() => setSelectedTask({...selectedTask, subtasks: [...(selectedTask.subtasks || []), {text:'', done:false}]})} style={{ padding: '0.5rem 0.75rem', borderRadius: '0.375rem', fontSize: '0.875rem', backgroundColor: '#BAFF39', border: 'none', cursor: 'pointer', marginTop: '0.5rem' }}>+ Agregar Subtarea</button>
                                    </div>
                                    <button onClick={() => {
                                        updateTask(selectedBoard.id, selectedTask.listId, selectedTask.id, selectedTask);
                                        setShowTaskModal(false);
                                    }} style={{ width: '100%', padding: '0.75rem', borderRadius: '0.375rem', backgroundColor: '#BAFF39', border: 'none', cursor: 'pointer', fontWeight: '600', fontSize: '1rem' }}>Guardar Cambios</button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const rootElement = document.getElementById('root');
        const root = ReactDOM.createRoot(rootElement);
        root.render(<App />);
    </script>
</body>
</html>
